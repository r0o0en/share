<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>商品详情页-判断APP</title>
		<meta name="author" content=""/>
		<meta name="keywords" content=""/>
		<meta name="description" content=""/>
		
		<meta name="renderer" content="webkit">
		<meta http-equiv= "X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, minimal-ui">
		<meta name="telephone=no" content="format-detection">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-capable" content="yes">
		
		<link rel="stylesheet" type="text/css" href="js/weui/weui.min.css"/>
		<link rel="stylesheet" type="text/css" href="js/weui/jquery-weui.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
		
		<!--<meta name='apple-itunes-app' content='app-id=1156008352'>-->
	</head>
	<body>      
			<div class="open-app">
				<div class="flex">
					<div class="info flex">
						<div class="esc "><i>x</i></div>
						<div class="flex-1 flex">
							<img class="logo" src="img/logo.png" />
							<p>打开吉粮惠民APP购物<br />购买即补贴粮票</p>
						</div>
					</div>
					<a class="open-app-btn flex-1" href="hmclient://TYPE=1&ID=110" id="openApp">打开APP</a>
					<!--<a class="open-app-btn flex-1" id="openApp">打开APP</a>-->
				</div>
			</div>
			
		<div class="page" >
			<div class="page-content">
				<section class="swiper-container">
					<div class="swiper-wrapper"></div>
					<div class="swiper-pagination"></div>
				</section>
				
				<div class="page-header">
					<h1 class="lib-context"></h1>
					<div class="flex lib-context price-line">
						<div class="flex-1"><span class="cl-red"></span><small><strike></strike></small>	</div>
						<div class="cu-quantity">
							<button class="cu-minus"></button>
							<input  class="cu-input" type="number" value="1" maxlength="" />
							<button class="cu-add" ></button>
						</div>
					</div>
				</div>
				
				<section class="weui-cells">
				  <a class="weui-cell weui-cell_access" href="javascript:;">
				  	
				  	<div class="weui-cell__hd"><img class=" ico-30 " src="img/ico-check.png"></div>
				    <div class="weui-cell__bd">
				      <p class="attribute">规格：暂无</p>
				    </div>
				  </a>
				</section>
				
				<section class="weui-cells">
				  <a class="weui-cell weui-cell_access" href="javascript:;">
				  	<div class="weui-cell__hd"><img class=" ico-30 " src="img/ico-check.png"></div>
				    <div class="weui-cell__bd">
				      <p class="store-name">商城</p>
				    </div>
				  </a>
				</section>
				
				<section class="weui-cells up-hint">
					<a class="weui-cell weui-cell_access" href="javascript:;">
						<div class="weui-cell__bd">
							<p style="text-align: center;">上拉查看图文详情</p>
						</div>
					</a>
				</section>
				
				<div class="load-more-info-content lib-context">
					
				</div>
				
				<div class="weui-loadmore" >
				  <i class="weui-loading"></i>
				  <span class="weui-loadmore__tips">正在加载</span>
				</div>
				
				<div class="occupy-footer"></div>
			</div>
		</div>
		<footer class="page-footer page-footer-fixed">
				<div class="flex">
					<a href="javascript:;" class="flex-1 weui-btn weui-btn_yello no-radius">加入购物车</a>
					<a href="javascript:;" class="flex-1 weui-btn weui-btn_red no-radius">去结算</a>
				</div>
		</footer>
		
		<!--<script src="//cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>-->
		<!--<script src="//cdn.bootcss.com/jquery-weui/1.0.1/js/jquery-weui.min.js"></script>-->
		<script src="js/zepto/zepto.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/zepto/fx.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/weui/jquery-weui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/swiper-3.4.2.jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/tool-nativeSchema.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/index_load.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			function couponHtml(li) {
				var arr = [];
				if(100 >= li.returnPointPercent && li.returnPointPercent >0 ){ /**(现金消费返积分比例)*/
					arr = ['补贴粮票',li.returnPointPercent]; 
				}else if(100>= li.deductPricePercent &&  li.deductPricePercent >0 ){/**(积分消费抵扣百分比)*/
					arr = ['粮票抵扣',li.deductPricePercent];
				}
				return arr;
			};
			$(function () {
				
				var data={},type;
				try{
					//获取url带参
					
					data = JSON.parse(getRequest().data);

//					for(var i in data ){
//						console.log(i,data[i]);
//					}
					//类型
					type = data.type;
				}catch(e){
					//alert('参数获取错误');
				}
				if(type&&data.url&&data.goodsId){
					$.ajax({
						type:"get",
						url:data.url,
						//url:"http://192.168.1.147:8080/v1.1/goods/getGoods",
						data:{type:type,goodsSkuId:data.goodsId},
						dataType:'jsonp',
						success:function (data) {
							console.log(data);
							if(data.code == 0){
								addContent(data.data);
							}
						},
						complete:function (xhr,status) {
//							console.log(arguments);
						}
					});
				}
				
				//加载打开APP
				$(".open-app").addClass('show');
				$(".open-app .esc").on('click',function (e) {
					$(".open-app").removeClass('show');
					setTimeout(function () {
						$(".open-app").remove();
					},400)
				})
//				$("#openApp").on('click',function(e){
//					e.preventDefault();
//					nativeSchema.loadSchema();
//				});
				
				
				function addContent(list) {//更新页面html
					
					if(!list){return false;}
					console.log(list);
					var i = 0 , str='' ;
					for(i in list ){
//						console.log(i,list[i]);
					}
					
					//幻灯片
					var imgs;
					imgs = (type == 'spellLuck') ? list.goodsImg :  list.imgs; /*  normal标准  spellLuck 拼手气*/ 
					
					if(typeof imgs != 'undefined'){
						arr = getImgurl(imgs);
						if(arr && arr.length) {
							for( i in arr) {
								str += '<div class="swiper-slide"><img src="' + arr[i] + '@800w" alt=""></div>';
							}
							$('.swiper-wrapper').append(str);
							$(".swiper-container").swiper({
								pagination: '.swiper-pagination',
								autoplay: "5000"
							});
						}
					}
					//商品名称
					if(typeof list.goodsName != 'undefined'){
						$('.page-header h1').text(list.goodsName);						
					}

					//商品价格 || 拼手气进度
					if(typeof list.price != 'undefined'){
						var str = '',
							cuQuantity_data ={};
						var before = parseInt( list.price ) ; //获取价格
							if(before) {
								if(list.deductPricePercent){ //粮票可抵扣百分比
									var now = ( 1 - parseInt( list.deductPricePercent )/100 )*before //现在的价格 ||
								}else{
									var now = before; // 现在的价格 
									before = false ; // 之前价格 
								}
								
								str += '<span class="cl-red">￥'+now+'</span>';
								if(before) {
									str += '<small><strike>￥'+before+'</strike></small>'
								}
							}else{
								str += '<span class="cl-red">暂无</span>';
							}
						if(type == 'normal'){ // 标准
							if(typeof list.limited  != 'undefined'){
								cuQuantity_data.max = list.limited;	
							}
						}else if(type == 'spellLuck'){ // 拼手气
							if( typeof list.amount != undefined && typeof list.leftAmount != undefined && typeof list.percent != undefined ){
								var amount = list.amount,//拼手气 需要的全部份数
									leftAmount = list.leftAmount, // 拼手气 剩余份数
									percent = list.percent; // 拼手气 现在的百分比
								if(typeof list.limitAmount  != 'undefined'){//每人限购
									cuQuantity_data.max = leftAmount <= list.limitAmount ?  leftAmount : list.limitAmount ;
								}else{
									cuQuantity_data.max = leftAmount;	
								}
								str = '<div class="weui-progress__bar">' +
										'<span class="left-amount">'+(percent)+'%</span>' +
							          	'<div class="weui-progress__inner-bar js_progress" style="width: '+(percent)+'%;"></div>' +
							          	'<span class="amount">'+amount+'份</span>' +
							        '</div>' + str ;
								
							}
						}
						$('.price-line > .flex-1').empty().append(str);
					}
					
					//加减控制器
					cuQuantity(cuQuantity_data);
					//配置 attributeList
//					list.attributeList="32G 皓银色"
					if(typeof list.attributeList  != 'undefined'){
						str = list.attributeList;
						str = '已选' + list.attributeList;
						$('.attribute').text(str);
					}
					
					//店铺名
					var str = getAttribute(data,'storeName');
					if(str){
						$('.store-name').text(str);
					}else{						
						$('.store-name').text('商城');
					}
					
					//加载详情
					str = false;
					if(typeof list.desc  != 'undefined'){str = list.desc} 
					var loading = false,
						callback = function() {
							if(loading) return;
							loading = true;
							$.showLoading();
							setTimeout(function() {
								$.hideLoading();
								if(str){
									loading = false;
									$('.load-more-info-content ').append(str);
									str = false;
								}else{
									$.toast("没有更多了", "text");
									callback = function(){};
									$('.page-content').destroyInfinite();
									$('.weui-loadmore').animate({
										'height':'0px',
										'opacity':'0',
										'margin':'0 auto'
									},400,function () {
										$('.weui-loadmore').addClass('hide');	
									});
								}
							}, 1500); //模拟延迟 
						};
					
					window.onload = function () {
						$('.page').infinite(25).on("infinite",callback);
						$('.page').addClass('yjjs');
					};
					
				}
				
		})	
		</script>
	</body>
</html>
